import{j as e,H as F,g as U,E as H}from"./index-Cx_wvEv2.js";import{u as B,r as l}from"./vendor-react-CnWnGStI.js";import{u as _}from"./vendor-redux-CmCFQHRP.js";import{a as L}from"./vendor-axios-B9ygI19o.js";import{P as $}from"./vendor-stripe-e-37tJ21.js";import"./vendor-sentry-YIXFnBwd.js";function q({reading:t,onClose:m}){var j,u,p,h,N,o;if(!t)return null;const n=a=>{a.target===a.currentTarget&&m()};return e.jsx("div",{className:"spread-modal-backdrop",onClick:n,children:e.jsxs("div",{className:"spread-modal",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:t.spreadName||"Ð Ð°ÑÐºÐ»Ð°Ð´ Ð¢Ð°Ñ€Ð¾"}),e.jsx("button",{onClick:m,className:"btn-close",children:"âœ•"})]}),e.jsxs("div",{className:"modal-body",children:[t.question&&e.jsxs("div",{className:"modal-question",children:[e.jsx("strong",{children:"Ð’Ð¾Ð¿Ñ€Ð¾Ñ:"})," ",t.question]}),((j=t.context)==null?void 0:j.partner)&&e.jsxs("div",{className:"modal-context",children:[e.jsx("strong",{children:"ÐŸÐ°Ñ€Ñ‚Ð½Ñ‘Ñ€:"})," ",t.context.partner]}),((u=t.context)==null?void 0:u.careerGoal)&&e.jsxs("div",{className:"modal-context",children:[e.jsx("strong",{children:"Ð¦ÐµÐ»ÑŒ:"})," ",t.context.careerGoal]}),((p=t.context)==null?void 0:p.yearGoal)&&e.jsxs("div",{className:"modal-context",children:[e.jsx("strong",{children:"Ð¦ÐµÐ»ÑŒ Ð½Ð° Ð³Ð¾Ð´:"})," ",t.context.yearGoal]}),e.jsxs("div",{className:"modal-date",children:["ðŸ“… ",new Date(t.createdAt).toLocaleDateString("ru-RU",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})]}),((h=t.interpretation)==null?void 0:h.summary)&&e.jsxs("div",{className:"modal-summary",children:[e.jsx("h3",{children:"ÐžÐ±Ñ‰ÐµÐµ Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ"}),e.jsx("p",{children:t.interpretation.summary})]}),e.jsxs("div",{className:"modal-cards",children:[e.jsxs("h3",{children:["Ð’Ñ‹Ñ‚ÑÐ½ÑƒÑ‚Ñ‹Ðµ ÐšÐ°Ñ€Ñ‚Ñ‹ (",t.cards.length,")"]}),e.jsx("div",{className:"modal-cards-grid",children:t.cards.map((a,r)=>e.jsxs("div",{className:"modal-card",children:[e.jsxs("div",{className:"modal-card-header",children:[e.jsxs("span",{className:"card-position",children:["#",r+1]}),a.reversed&&e.jsx("span",{className:"reversed-tag",children:"âš¡ ÐŸÐµÑ€ÐµÐ²Ñ‘Ñ€Ð½ÑƒÑ‚Ð°"})]}),e.jsx("div",{className:"modal-card-name",children:a.cardName||a.name}),a.positionName&&e.jsx("div",{className:"modal-card-position",children:a.positionName})]},r))})]}),((N=t.interpretation)==null?void 0:N.text)&&e.jsxs("div",{className:"modal-interpretation",children:[e.jsx("h3",{children:"Ð˜Ð½Ñ‚ÐµÑ€Ð¿Ñ€ÐµÑ‚Ð°Ñ†Ð¸Ñ"}),e.jsx("p",{children:t.interpretation.text})]}),((o=t.interpretation)==null?void 0:o.positions)&&e.jsxs("div",{className:"modal-positions",children:[e.jsx("h3",{children:"ÐŸÐ¾Ð·Ð¸Ñ†Ð¸Ð¸ Ð Ð°ÑÐºÐ»Ð°Ð´Ð°"}),t.interpretation.positions.map((a,r)=>{var d;return e.jsxs("div",{className:"modal-position-item",children:[e.jsxs("div",{className:"position-title",children:[e.jsx("span",{className:"position-num",children:r+1}),e.jsx("strong",{children:a.positionName})]}),e.jsx("div",{className:"position-card-name",children:((d=a.card)==null?void 0:d.name)||a.card}),e.jsx("p",{className:"position-meaning",children:a.interpretation||a.meaning})]},r)})]})]}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{onClick:m,className:"btn-primary",children:"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"})})]})})}q.propTypes={reading:$.object,onClose:$.func.isRequired};const g="/api";function Q(){const{token:t}=_(s=>s.auth),m=B(),[n,j]=l.useState([]),[u,p]=l.useState([]),[h,N]=l.useState(!0),[o,a]=l.useState(null),[r,d]=l.useState("all"),[v,f]=l.useState(null),P=async s=>{try{const i=await L.get(`${g}/readings/${s}/pdf`,{headers:{Authorization:`Bearer ${t}`},responseType:"blob"}),y=window.URL.createObjectURL(new Blob([i.data])),c=document.createElement("a");c.href=y,c.setAttribute("download",`tarot-reading-${s}.pdf`),document.body.appendChild(c),c.click(),c.remove()}catch(i){console.error("PDF export error:",i),alert("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ PDF")}};l.useEffect(()=>{b()},[]),l.useEffect(()=>{p(r==="all"?n:n.filter(s=>s.type===r||s.spreadType===r))},[n,r]);const b=async()=>{try{a(null);const s=await L.get(`${g}/readings/history?limit=50`,{headers:{Authorization:`Bearer ${t}`}});j(s.data.data.readings||[])}catch(s){console.error("Load history error:",s),a(s)}finally{N(!1)}},G=(s,i)=>{switch(s){case"daily":return"ðŸ“… Ð Ð°ÑÐºÐ»Ð°Ð´ Ð”Ð½Ñ";case"decision":return"ðŸŽ¯ ÐÐ½Ð°Ð»Ð¸Ð· Ð ÐµÑˆÐµÐ½Ð¸Ñ";case"purchase":return"ðŸ›’ ÐŸÐ¾ÐºÑƒÐ¿ÐºÐ°";case"spread":return i.spreadName?i.spreadName:i.spreadType==="celtic-cross"?"ðŸ”® ÐšÐµÐ»ÑŒÑ‚ÑÐºÐ¸Ð¹ ÐšÑ€ÐµÑÑ‚":i.spreadType==="relationship"?"ðŸ’• Ð Ð°ÑÐºÐ»Ð°Ð´ ÐžÑ‚Ð½Ð¾ÑˆÐµÐ½Ð¸Ð¹":i.spreadType==="career-path"?"ðŸ’¼ ÐšÐ°Ñ€ÑŒÐµÑ€Ð½Ñ‹Ð¹ ÐŸÑƒÑ‚ÑŒ":i.spreadType==="year-ahead"?"ðŸŽ† ÐŸÑƒÑ‚ÑŒ Ð“Ð¾Ð´Ð°":"ðŸŽ´ Ð Ð°ÑÐºÐ»Ð°Ð´";default:return s}};return e.jsxs("div",{className:"history-page",children:[e.jsx(F,{}),e.jsxs("header",{className:"reading-header",children:[e.jsx("button",{onClick:()=>m("/dashboard"),className:"btn-back",children:"â† ÐÐ°Ð·Ð°Ð´"}),e.jsx("h1",{children:"ðŸ“– Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð Ð°ÑÐºÐ»Ð°Ð´Ð¾Ð²"})]}),e.jsxs("main",{className:"history-content",children:[!h&&!o&&n.length>0&&e.jsxs("div",{className:"filter-bar",children:[e.jsxs("button",{className:`filter-btn ${r==="all"?"active":""}`,onClick:()=>d("all"),children:["Ð’ÑÐµ (",n.length,")"]}),e.jsxs("button",{className:`filter-btn ${r==="daily"?"active":""}`,onClick:()=>d("daily"),children:["ðŸ“… Ð”Ð½ÐµÐ²Ð½Ñ‹Ðµ (",n.filter(s=>s.type==="daily").length,")"]}),e.jsxs("button",{className:`filter-btn ${r==="spread"?"active":""}`,onClick:()=>d("spread"),children:["ðŸŽ´ Ð Ð°ÑÐºÐ»Ð°Ð´Ñ‹ (",n.filter(s=>s.type==="spread").length,")"]}),e.jsxs("button",{className:`filter-btn ${r==="decision"?"active":""}`,onClick:()=>d("decision"),children:["ðŸŽ¯ Ð ÐµÑˆÐµÐ½Ð¸Ñ (",n.filter(s=>s.type==="decision").length,")"]})]}),h&&e.jsx(U,{count:5}),o&&e.jsx(H,{error:o,onRetry:b,context:{page:"history"}}),!h&&!o&&n.length===0&&e.jsxs("div",{className:"empty-state",children:[e.jsx("div",{className:"empty-icon",children:"ðŸ”®"}),e.jsx("h2",{children:"ÐŸÐ¾ÐºÐ° Ð½ÐµÑ‚ Ñ€Ð°ÑÐºÐ»Ð°Ð´Ð¾Ð²"}),e.jsx("p",{children:"Ð’Ð°ÑˆÐ¸ Ñ€Ð°ÑÐºÐ»Ð°Ð´Ñ‹ Ð±ÑƒÐ´ÑƒÑ‚ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°Ñ‚ÑŒÑÑ Ð·Ð´ÐµÑÑŒ"}),e.jsx("button",{onClick:()=>m("/reading/daily"),className:"btn-primary",children:"Ð’Ñ‹Ñ‚ÑÐ½ÑƒÑ‚ÑŒ ÐŸÐµÑ€Ð²ÑƒÑŽ ÐšÐ°Ñ€Ñ‚Ñƒ"})]}),e.jsx("div",{className:"history-list",children:u.map(s=>{var i,y,c,k,R,S,C,w,D,T,E;return e.jsxs("div",{className:"history-item",children:[e.jsxs("div",{className:"history-header",children:[e.jsx("span",{className:"type-badge",children:G(s.type,s)}),e.jsx("span",{className:"date",children:new Date(s.createdAt).toLocaleDateString("ru-RU",{day:"numeric",month:"long",year:"numeric"})})]}),e.jsxs("div",{className:"history-body",children:[(s.question||((i=s.context)==null?void 0:i.question))&&e.jsxs("div",{className:"question-text",children:[e.jsx("strong",{children:"Ð’Ð¾Ð¿Ñ€Ð¾Ñ:"})," ",s.question||((y=s.context)==null?void 0:y.question)]}),s.type==="spread"&&((c=s.context)==null?void 0:c.partner)&&e.jsxs("div",{className:"context-info",children:[e.jsx("strong",{children:"ÐŸÐ°Ñ€Ñ‚Ð½Ñ‘Ñ€:"})," ",s.context.partner]}),s.type==="spread"&&((k=s.context)==null?void 0:k.careerGoal)&&e.jsxs("div",{className:"context-info",children:[e.jsx("strong",{children:"Ð¦ÐµÐ»ÑŒ:"})," ",s.context.careerGoal]}),s.type==="spread"&&((R=s.context)==null?void 0:R.yearGoal)&&e.jsxs("div",{className:"context-info",children:[e.jsx("strong",{children:"Ð¦ÐµÐ»ÑŒ Ð½Ð° Ð³Ð¾Ð´:"})," ",s.context.yearGoal]}),e.jsx("div",{className:"cards-summary",children:s.cards.map((x,A)=>e.jsxs("div",{className:"card-mini",children:[e.jsxs("span",{className:"card-name",children:[x.cardName||x.name,x.reversed&&" (â†“)"]}),s.type==="decision"&&x.positionName&&e.jsx("span",{className:"position-mini",children:x.positionName})]},A))}),e.jsxs("div",{className:"interpretation-preview",children:[((C=(S=s.interpretation)==null?void 0:S.summary)==null?void 0:C.substring(0,150))||((D=(w=s.interpretation)==null?void 0:w.text)==null?void 0:D.substring(0,150)),(((T=s.interpretation)==null?void 0:T.summary)||((E=s.interpretation)==null?void 0:E.text))&&"..."]}),s.type==="spread"&&e.jsx("div",{className:"spread-meta",children:e.jsxs("span",{className:"card-count",children:[s.cards.length," ÐºÐ°Ñ€Ñ‚"]})})]}),e.jsxs("div",{className:"history-footer",children:[e.jsxs("span",{className:"time",children:["ðŸ• ",new Date(s.createdAt).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})]}),e.jsxs("div",{className:"footer-actions",children:[e.jsx("button",{onClick:()=>f(s),className:"btn-view",title:"ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ",children:"ðŸ‘ï¸ ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€"}),e.jsx("button",{onClick:()=>P(s._id),className:"btn-pdf-export",title:"Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð² PDF",children:"ðŸ“„ PDF"})]})]})]},s._id)})})]}),v&&e.jsx(q,{reading:v,onClose:()=>f(null)})]})}export{Q as default};
