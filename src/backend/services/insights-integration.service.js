/**
 * Insights Integration Service
 * –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –¢–∞—Ä–æ + –ê—Å—Ç—Ä–æ–ª–æ–≥–∏—é + –ù—É–º–µ—Ä–æ–ª–æ–≥–∏—é + –õ—É–Ω—É –¥–ª—è –≥–ª—É–±–æ–∫–∏—Ö –∏–Ω—Å–∞–π—Ç–æ–≤
 * –≠—Ç–æ –Ω–∞—à–µ –£–ù–ò–ö–ê–õ–¨–ù–û–ï –ü–†–ï–ò–ú–£–©–ï–°–¢–í–û!
 */

const moonPhasesService = require('./moon-phases.service');
const db = require('../db/json-store');

class InsightsIntegrationService {
  /**
   * –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   */
  async getUnifiedInsights(userId) {
    try {
      const user = await db.findOne('users', { _id: userId });
      if (!user) return null;

      const insights = {
        astrology: user.astrology || null,
        numerology: user.numerology || null,
        moonPhase: moonPhasesService.calculateMoonPhase(),
        integration: {}
      };

      // –°–æ–∑–¥–∞—ë–º –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã
      insights.integration = this.generateIntegratedInsights(insights);

      return insights;
    } catch (error) {
      console.error('Get unified insights error:', error);
      return null;
    }
  }

  /**
   * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
   */
  generateIntegratedInsights(data) {
    const { astrology, numerology, moonPhase } = data;
    const insights = {
      personalizedReading: '',
      bestReadingTime: '',
      focusAreas: [],
      warnings: [],
      opportunities: []
    };

    // –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    if (astrology && numerology) {
      const sun = astrology.sun?.sign || '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
      const lifePath = numerology.numbers?.lifePath?.value;

      insights.personalizedReading = `–í–∞—à —Å–æ–ª–Ω–µ—á–Ω—ã–π –∑–Ω–∞–∫ ${sun} –∏ —á–∏—Å–ª–æ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ –ø—É—Ç–∏ ${lifePath} —Å–æ–∑–¥–∞—é—Ç —É–Ω–∏–∫–∞–ª—å–Ω—É—é –º–∞–≥–∏—é: `;

      // –ö–æ–º–±–∏–Ω–∞—Ü–∏—è –∑–Ω–∞–∫–∞ –∏ —á–∏—Å–ª–∞
      if (this.isFireSign(sun) && [1, 3, 5, 9].includes(lifePath)) {
        insights.personalizedReading += '–æ–≥–Ω–µ–Ω–Ω–∞—è —Å—Ç—Ä–∞—Å—Ç—å —Å–æ–µ–¥–∏–Ω—è–µ—Ç—Å—è —Å —ç–Ω–µ—Ä–≥–∏–µ–π –¥–µ–π—Å—Ç–≤–∏—è. –ò–¥–µ–∞–ª—å–Ω—ã–π –º–æ–º–µ–Ω—Ç –¥–ª—è —Å–º–µ–ª—ã—Ö —à–∞–≥–æ–≤ –∏ –Ω–æ–≤—ã—Ö –Ω–∞—á–∏–Ω–∞–Ω–∏–π!';
        insights.opportunities.push('–û–≥–Ω–µ–Ω–Ω–∞—è —Å—Ç–∏—Ö–∏—è —É—Å–∏–ª–µ–Ω–∞ –≤–∞—à–∏–º —á–∏—Å–ª–æ–º ‚Äî —Å–µ–π—á–∞—Å –≤—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ –∏ —Å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é');
      } else if (this.isWaterSign(sun) && [2, 6, 7, 11].includes(lifePath)) {
        insights.personalizedReading += '–≤–æ–¥–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ —Å–æ–µ–¥–∏–Ω—è–µ—Ç—Å—è —Å –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ–π –º—É–¥—Ä–æ—Å—Ç—å—é. –î–æ–≤–µ—Ä—è–π—Ç–µ —Å–≤–æ–µ–º—É –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –≥–æ–ª–æ—Å—É –∏ —á—É–≤—Å—Ç–≤–∞–º.';
        insights.opportunities.push('–í–æ–¥–Ω–∞—è —Å—Ç–∏—Ö–∏—è —Ä–µ–∑–æ–Ω–∏—Ä—É–µ—Ç —Å –≤–∞—à–∏–º —á–∏—Å–ª–æ–º ‚Äî –ø–æ–≥—Ä—É–∑–∏—Ç–µ—Å—å –≤ –¥—É—Ö–æ–≤–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –∏ –º–µ–¥–∏—Ç–∞—Ü–∏—é');
      } else if (this.isEarthSign(sun) && [4, 8, 22].includes(lifePath)) {
        insights.personalizedReading += '–∑–µ–º–Ω–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Å–æ–µ–¥–∏–Ω—è–µ—Ç—Å—è —Å —Å–∏–ª–æ–π —Å—Ç—Ä–æ–∏—Ç–µ–ª—è. –í–∞—à–∏ –ø–ª–∞–Ω—ã –æ–±—Ä–µ—Ç—É—Ç –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—É—é —Ñ–æ—Ä–º—É.';
        insights.opportunities.push('–ó–µ–º–Ω–∞—è –ø—Ä–∏—Ä–æ–¥–∞ —É—Å–∏–ª–∏–≤–∞–µ—Ç –≤–∞—à–µ —á–∏—Å–ª–æ ‚Äî –Ω–∞—á–∏–Ω–∞–π—Ç–µ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –∏ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç');
      } else if (this.isAirSign(sun) && [3, 5].includes(lifePath)) {
        insights.personalizedReading += '–≤–æ–∑–¥—É—à–Ω–∞—è –ª—ë–≥–∫–æ—Å—Ç—å —Å–æ–µ–¥–∏–Ω—è–µ—Ç—Å—è —Å —Ç–≤–æ—Ä—á–µ—Å–∫–æ–π –∏—Å–∫—Ä–æ–π. –í–∞—à–∏ –∏–¥–µ–∏ –Ω–∞–π–¥—É—Ç –æ—Ç–∫–ª–∏–∫ —É –¥—Ä—É–≥–∏—Ö.';
        insights.opportunities.push('–í–æ–∑–¥—É—à–Ω–∞—è —Å—Ç–∏—Ö–∏—è –≥–∞—Ä–º–æ–Ω–∏—Ä—É–µ—Ç —Å –≤–∞—à–∏–º —á–∏—Å–ª–æ–º ‚Äî –¥–µ–ª–∏—Ç–µ—Å—å –∏–¥–µ—è–º–∏, –æ–±—â–∞–π—Ç–µ—Å—å, –≤–¥–æ—Ö–Ω–æ–≤–ª—è–π—Ç–µ');
      } else {
        insights.personalizedReading += '–≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –≥–∞—Ä–º–æ–Ω–∏–∏ –º–µ–∂–¥—É —Å—Ç–∏—Ö–∏—è–º–∏ –∏ —á–∏—Å–ª–∞–º–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç –±–∞–ª–∞–Ω—Å –¥–ª—è –ª—é–±—ã—Ö –Ω–∞—á–∏–Ω–∞–Ω–∏–π.';
        insights.opportunities.push('–í–∞—à–∞ —É–Ω–∏–∫–∞–ª—å–Ω–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è —ç–Ω–µ—Ä–≥–∏–π –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø—É—Ç–µ–π ‚Äî –≤—ã–±–∏—Ä–∞–π—Ç–µ —Ç–æ, —á—Ç–æ —Ä–µ–∑–æ–Ω–∏—Ä—É–µ—Ç');
      }
    }

    // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–∑—ã –õ—É–Ω—ã
    if (moonPhase) {
      insights.bestReadingTime = this.getMoonPhaseReadingAdvice(moonPhase, astrology);

      // –õ—É–Ω–∞ + –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—è
      if (astrology && astrology.moon) {
        const moonSign = astrology.moon.sign;
        if (moonPhase.phaseName === '–ü–æ–ª–Ω–æ–ª—É–Ω–∏–µ') {
          insights.opportunities.push(
            `–ü–æ–ª–Ω–æ–ª—É–Ω–∏–µ –æ–∑–∞—Ä—è–µ—Ç –≤–∞—à—É –ª—É–Ω–Ω—É—é –ø—Ä–∏—Ä–æ–¥—É ${moonSign} ‚Äî —Å–µ–π—á–∞—Å –æ—Å–æ–±–µ–Ω–Ω–æ –º–æ—â–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –≥–ª—É–±–æ–∫–∏—Ö —Ä–∞—Å–∫–ª–∞–¥–æ–≤ –∏ —Ä–∏—Ç—É–∞–ª–æ–≤`
          );
        } else if (moonPhase.phaseName === '–ù–æ–≤–æ–ª—É–Ω–∏–µ') {
          insights.opportunities.push(
            `–ù–æ–≤–æ–ª—É–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –≤–∞—à—É —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –ø—Ä–∏—Ä–æ–¥—É ${moonSign} ‚Äî –∏–¥–µ–∞–ª—å–Ω—ã–π –º–æ–º–µ–Ω—Ç –¥–ª—è –∑–∞–≥–∞–¥—ã–≤–∞–Ω–∏—è –∂–µ–ª–∞–Ω–∏–π`
          );
        }
      }

      // –õ—É–Ω–∞ + –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—è
      if (numerology && numerology.numbers) {
        const personalYear = numerology.numbers.personalYear.value;
        const yearMeanings = {
          1: { theme: '–Ω–æ–≤—ã–µ –Ω–∞—á–∏–Ω–∞–Ω–∏—è –∏ —Å–º–µ–ª—ã–µ —à–∞–≥–∏', newMoon: '–∑–∞–ø—É—Å–∫–∞–π—Ç–µ –Ω–æ–≤—ã–µ –ø—Ä–æ–µ–∫—Ç—ã', fullMoon: '–ø—Ä–∞–∑–¥–Ω—É–π—Ç–µ –ø–µ—Ä–≤—ã–µ –ø–æ–±–µ–¥—ã' },
          2: { theme: '–ø–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–æ –∏ –±–∞–ª–∞–Ω—Å', newMoon: '—É–∫—Ä–µ–ø–ª—è–π—Ç–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è', fullMoon: '–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç–µ –±–ª–∏–∑–∫–∏—Ö' },
          3: { theme: '—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ –∏ —Å–∞–º–æ–≤—ã—Ä–∞–∂–µ–Ω–∏–µ', newMoon: '–Ω–∞—á–∏–Ω–∞–π—Ç–µ —Ç–≤–æ—Ä—á–µ—Å–∫–∏–µ –ø—Ä–æ–µ–∫—Ç—ã', fullMoon: '–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º –∏—Å–∫—É—Å—Å—Ç–≤–æ–º' },
          4: { theme: '–ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞', newMoon: '–∑–∞–∫–ª–∞–¥—ã–≤–∞–π—Ç–µ –æ—Å–Ω–æ–≤—É', fullMoon: '–æ—Ü–µ–Ω–∏—Ç–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—É—é —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å' },
          5: { theme: '–ø–µ—Ä–µ–º–µ–Ω—ã –∏ —Å–≤–æ–±–æ–¥–∞', newMoon: '–≤—ã—Ö–æ–¥–∏—Ç–µ –∏–∑ –∑–æ–Ω—ã –∫–æ–º—Ñ–æ—Ä—Ç–∞', fullMoon: '—Ä–∞–¥—É–π—Ç–µ—Å—å –Ω–æ–≤–æ–º—É –æ–ø—ã—Ç—É' },
          6: { theme: '–ª—é–±–æ–≤—å –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å', newMoon: '–∑–∞–±–æ—Ç—å—Ç–µ—Å—å –æ –ª—é–±–∏–º—ã—Ö', fullMoon: '—Ü–µ–Ω–∏—Ç–µ –≥–∞—Ä–º–æ–Ω–∏—é –≤ –¥–æ–º–µ' },
          7: { theme: '–¥—É—Ö–æ–≤–Ω—ã–π —Ä–æ—Å—Ç', newMoon: '–ø–æ–≥—Ä—É–∂–∞–π—Ç–µ—Å—å –≤ –ø—Ä–∞–∫—Ç–∏–∫–∏', fullMoon: '–¥–µ–ª–∏—Ç–µ—Å—å –º—É–¥—Ä–æ—Å—Ç—å—é' },
          8: { theme: '–∏–∑–æ–±–∏–ª–∏–µ –∏ —Å–∏–ª–∞', newMoon: '–ø—Ä–∏–≤–ª–µ–∫–∞–π—Ç–µ –ø—Ä–æ—Ü–≤–µ—Ç–∞–Ω–∏–µ', fullMoon: '–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç–µ –∑–∞ –¥–æ—Å—Ç–∞—Ç–æ–∫' },
          9: { theme: '–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ü–∏–∫–ª–æ–≤', newMoon: '–æ—Ç–ø—É—Å–∫–∞–π—Ç–µ —Å—Ç–∞—Ä–æ–µ', fullMoon: '–ø—Ä–∞–∑–¥–Ω—É–π—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è' },
          11: { theme: '–¥—É—Ö–æ–≤–Ω–æ–µ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ', newMoon: '–º–µ–¥–∏—Ç–∏—Ä—É–π—Ç–µ –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –æ–∑–∞—Ä–µ–Ω–∏—è', fullMoon: '–¥–æ–≤–µ—Ä—è–π—Ç–µ –∏–Ω—Ç—É–∏—Ü–∏–∏' },
          22: { theme: '–≤–æ–ø–ª–æ—â–µ–Ω–∏–µ –≥—Ä–∞–Ω–¥–∏–æ–∑–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤', newMoon: '–Ω–∞—á–∏–Ω–∞–π—Ç–µ –º–∞—Å—à—Ç–∞–±–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã', fullMoon: '–≤–∏–¥–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã' }
        };

        const yearData = yearMeanings[personalYear] || { theme: '—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è', newMoon: '—Å—Ç–∞–≤—å—Ç–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è', fullMoon: '–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç–µ' };

        if (moonPhase.phaseName === '–ù–æ–≤–æ–ª—É–Ω–∏–µ') {
          insights.opportunities.push(
            `–°–µ–π—á–∞—Å –ù–æ–≤–æ–ª—É–Ω–∏–µ –≤ –≤–∞—à–µ–º –ª–∏—á–Ω–æ–º –≥–æ–¥—É, –≥–¥–µ –≥–ª–∞–≤–Ω–∞—è —Ç–µ–º–∞ ‚Äî ${yearData.theme}. –≠—Ç–æ –∏–¥–µ–∞–ª—å–Ω—ã–π –º–æ–º–µ–Ω—Ç, —á—Ç–æ–±—ã ${yearData.newMoon}`
          );
        } else if (moonPhase.phaseName === '–ü–æ–ª–Ω–æ–ª—É–Ω–∏–µ') {
          insights.opportunities.push(
            `–ü–æ–ª–Ω–æ–ª—É–Ω–∏–µ –æ–∑–∞—Ä—è–µ—Ç –≤–∞—à –ª–∏—á–Ω—ã–π –≥–æ–¥ —Å —Ç–µ–º–æ–π "${yearData.theme}". –°–µ–π—á–∞—Å –≤—Ä–µ–º—è ${yearData.fullMoon}`
          );
        }
      }
    }

    // –§–æ–∫—É—Å–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
    insights.focusAreas = this.getFocusAreas(astrology, numerology, moonPhase);

    return insights;
  }

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç —Å–æ–≤–µ—Ç –ø–æ —Ä–∞—Å–∫–ª–∞–¥—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–∑—ã –õ—É–Ω—ã –∏ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏–∏
   */
  getMoonPhaseReadingAdvice(moonPhase, astrology) {
    // –£–ª—É—á—à–µ–Ω–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã
    const phaseAdvice = {
      '–ù–æ–≤–æ–ª—É–Ω–∏–µ': '–∏–¥–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è —Ä–∞—Å–∫–ª–∞–¥–æ–≤ –Ω–∞ –Ω–æ–≤—ã–µ –Ω–∞—á–∏–Ω–∞–Ω–∏—è, –ø–æ—Å—Ç–∞–Ω–æ–≤–∫—É —Ü–µ–ª–µ–π –∏ –∑–∞–≥–∞–¥—ã–≤–∞–Ω–∏–µ –∂–µ–ª–∞–Ω–∏–π',
      '–†–∞—Å—Ç—É—â–∞—è –õ—É–Ω–∞': '–±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –¥–ª—è —Ä–∞—Å–∫–ª–∞–¥–æ–≤ –Ω–∞ —Ä–∞–∑–≤–∏—Ç–∏–µ, —Ä–æ—Å—Ç –∏ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ –∂–µ–ª–∞–µ–º–æ–≥–æ',
      '–ü–æ–ª–Ω–æ–ª—É–Ω–∏–µ': '–º–æ—â–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è —Ä–∞—Å–∫–ª–∞–¥–æ–≤ –Ω–∞ –æ–∑–∞—Ä–µ–Ω–∏–µ, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ü–∏–∫–ª–æ–≤ –∏ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å',
      '–£–±—ã–≤–∞—é—â–∞—è –õ—É–Ω–∞': '–ø–æ–¥—Ö–æ–¥—è—â–∏–π –º–æ–º–µ–Ω—Ç –¥–ª—è —Ä–∞—Å–∫–ª–∞–¥–æ–≤ –Ω–∞ –æ—Ç–ø—É—Å–∫–∞–Ω–∏–µ, –æ—á–∏—â–µ–Ω–∏–µ –∏ –∏–∑–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç –ª–∏—à–Ω–µ–≥–æ'
    };

    let advice = phaseAdvice[moonPhase.phaseName] || moonPhase.recommendations.tarot;

    if (astrology && astrology.moon) {
      // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ –ª—É–Ω–Ω—ã–π –∑–Ω–∞–∫
      const moonSignQualities = {
        '–û–≤–µ–Ω': '–¥–µ–π—Å—Ç–≤–∏–µ –∏ —Å–º–µ–ª–æ—Å—Ç—å',
        '–¢–µ–ª–µ—Ü': '—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã',
        '–ë–ª–∏–∑–Ω–µ—Ü—ã': '–æ–±—â–µ–Ω–∏–µ –∏ –æ–±—É—á–µ–Ω–∏–µ',
        '–†–∞–∫': '—ç–º–æ—Ü–∏–∏ –∏ —Å–µ–º—å—é',
        '–õ–µ–≤': '—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ –∏ —Å–∞–º–æ–≤—ã—Ä–∞–∂–µ–Ω–∏–µ',
        '–î–µ–≤–∞': '–ø–æ—Ä—è–¥–æ–∫ –∏ –∑–¥–æ—Ä–æ–≤—å–µ',
        '–í–µ—Å—ã': '–æ—Ç–Ω–æ—à–µ–Ω–∏—è –∏ –≥–∞—Ä–º–æ–Ω–∏—é',
        '–°–∫–æ—Ä–ø–∏–æ–Ω': '—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ –≥–ª—É–±–∏–Ω—É',
        '–°—Ç—Ä–µ–ª–µ—Ü': '—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è',
        '–ö–æ–∑–µ—Ä–æ–≥': '–∞–º–±–∏—Ü–∏–∏ –∏ –∫–∞—Ä—å–µ—Ä—É',
        '–í–æ–¥–æ–ª–µ–π': '–∏–Ω–Ω–æ–≤–∞—Ü–∏–∏ –∏ —Å–≤–æ–±–æ–¥—É',
        '–†—ã–±—ã': '–∏–Ω—Ç—É–∏—Ü–∏—é –∏ –¥—É—Ö–æ–≤–Ω–æ—Å—Ç—å'
      };

      const quality = moonSignQualities[astrology.moon.sign];
      if (quality && moonPhase.phaseName === '–ü–æ–ª–Ω–æ–ª—É–Ω–∏–µ') {
        advice += `. –í–∞—à–∞ –õ—É–Ω–∞ –≤ ${astrology.moon.sign} —É—Å–∏–ª–∏–≤–∞–µ—Ç —Ç–µ–º—ã –Ω–∞ ${quality}`;
      }
    }

    return advice;
  }

  /**
   * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ñ–æ–∫—É—Å–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏
   */
  getFocusAreas(astrology, numerology, moonPhase) {
    const areas = [];

    // –ù–∞ –æ—Å–Ω–æ–≤–µ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏–∏
    if (astrology) {
      if (astrology.strengths && astrology.strengths.length > 0) {
        areas.push({
          source: '–ê—Å—Ç—Ä–æ–ª–æ–≥–∏—è',
          area: astrology.strengths[0],
          icon: '‚≠ê'
        });
      }
    }

    // –ù–∞ –æ—Å–Ω–æ–≤–µ –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏–∏
    if (numerology && numerology.recommendations) {
      if (numerology.recommendations.thisYear && numerology.recommendations.thisYear.length > 0) {
        areas.push({
          source: '–ù—É–º–µ—Ä–æ–ª–æ–≥–∏—è',
          area: numerology.recommendations.thisYear[0],
          icon: 'üî¢'
        });
      }
    }

    // –ù–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–∑—ã –õ—É–Ω—ã
    if (moonPhase && moonPhase.recommendations) {
      const moonRec = moonPhase.recommendations.general;
      if (moonRec && moonRec.length > 0) {
        areas.push({
          source: '–õ—É–Ω–∞',
          area: moonRec[0],
          icon: 'üåô'
        });
      }
    }

    return areas;
  }

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é –∫–∞—Ä—Ç—ã
   */
  getPersonalizedCardInterpretation(card, userData) {
    const { astrology, numerology, moonPhase } = userData;
    let interpretation = card.meaning || '';

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏–∏
    if (astrology && astrology.sun) {
      interpretation += this.getAstroContext(card, astrology.sun.sign);
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏–∏
    if (numerology && numerology.numbers) {
      interpretation += this.getNumerologyContext(card, numerology.numbers.lifePath.value);
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –õ—É–Ω—ã
    if (moonPhase) {
      interpretation += ` ${moonPhase.emoji} –í ${moonPhase.phaseName} —ç—Ç–∞ –∫–∞—Ä—Ç–∞ —É—Å–∏–ª–∏–≤–∞–µ—Ç ${moonPhase.energy}.`;
    }

    return interpretation;
  }

  /**
   * –î–æ–±–∞–≤–ª—è–µ—Ç –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
   */
  getAstroContext(card, sunSign) {
    // –°–≤—è–∑—å –∫–∞—Ä—Ç —Å–æ –∑–Ω–∞–∫–∞–º–∏
    const cardZodiacMap = {
      '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä': ['–û–≤–µ–Ω'],
      '–ò–µ—Ä–æ—Ñ–∞–Ω—Ç': ['–¢–µ–ª–µ—Ü'],
      '–í–ª—é–±–ª—ë–Ω–Ω—ã–µ': ['–ë–ª–∏–∑–Ω–µ—Ü—ã'],
      '–ö–æ–ª–µ—Å–Ω–∏—Ü–∞': ['–†–∞–∫'],
      '–°–∏–ª–∞': ['–õ–µ–≤'],
      '–û—Ç—à–µ–ª—å–Ω–∏–∫': ['–î–µ–≤–∞'],
      '–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å': ['–í–µ—Å—ã'],
      '–°–º–µ—Ä—Ç—å': ['–°–∫–æ—Ä–ø–∏–æ–Ω'],
      '–£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å': ['–°—Ç—Ä–µ–ª–µ—Ü'],
      '–î—å—è–≤–æ–ª': ['–ö–æ–∑–µ—Ä–æ–≥'],
      '–ó–≤–µ–∑–¥–∞': ['–í–æ–¥–æ–ª–µ–π'],
      '–õ—É–Ω–∞': ['–†—ã–±—ã']
    };

    const relatedSigns = cardZodiacMap[card.name] || [];
    if (relatedSigns.includes(sunSign)) {
      return ` ‚≠ê –≠—Ç–∞ –∫–∞—Ä—Ç–∞ –æ—Å–æ–±–µ–Ω–Ω–æ —Ä–µ–∑–æ–Ω–∏—Ä—É–µ—Ç —Å –≤–∞—à–∏–º –∑–Ω–∞–∫–æ–º ${sunSign}!`;
    }

    return '';
  }

  /**
   * –î–æ–±–∞–≤–ª—è–µ—Ç –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
   */
  getNumerologyContext(card, lifePath) {
    // –°–≤—è–∑—å –∫–∞—Ä—Ç —Å —á–∏—Å–ª–∞–º–∏
    const cardNumberMap = {
      '–ú–∞–≥': [1],
      '–í–µ—Ä—Ö–æ–≤–Ω–∞—è –ñ—Ä–∏—Ü–∞': [2],
      '–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞': [3],
      '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä': [4],
      '–ò–µ—Ä–æ—Ñ–∞–Ω—Ç': [5],
      '–í–ª—é–±–ª—ë–Ω–Ω—ã–µ': [6],
      '–ö–æ–ª–µ—Å–Ω–∏—Ü–∞': [7],
      '–°–∏–ª–∞': [8],
      '–û—Ç—à–µ–ª—å–Ω–∏–∫': [9],
      '–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å': [11],
      '–ü–æ–≤–µ—à–µ–Ω–Ω—ã–π': [22]
    };

    const relatedNumbers = cardNumberMap[card.name] || [];
    if (relatedNumbers.includes(lifePath)) {
      return ` üî¢ –≠—Ç–∞ –∫–∞—Ä—Ç–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –≤–∞—à–∏–º —á–∏—Å–ª–æ–º –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ –ø—É—Ç–∏ ${lifePath}!`;
    }

    return '';
  }

  /**
   * –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∏—Ö–∏–π
   */
  isFireSign(sign) {
    return ['–û–≤–µ–Ω', '–õ–µ–≤', '–°—Ç—Ä–µ–ª–µ—Ü'].includes(sign);
  }

  isWaterSign(sign) {
    return ['–†–∞–∫', '–°–∫–æ—Ä–ø–∏–æ–Ω', '–†—ã–±—ã'].includes(sign);
  }

  isEarthSign(sign) {
    return ['–¢–µ–ª–µ—Ü', '–î–µ–≤–∞', '–ö–æ–∑–µ—Ä–æ–≥'].includes(sign);
  }

  isAirSign(sign) {
    return ['–ë–ª–∏–∑–Ω–µ—Ü—ã', '–í–µ—Å—ã', '–í–æ–¥–æ–ª–µ–π'].includes(sign);
  }

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω—Å–∞–π—Ç
   */
  async getDailyPersonalizedInsight(userId) {
    const insights = await this.getUnifiedInsights(userId);
    if (!insights) return null;

    const { astrology, numerology, moonPhase, integration } = insights;

    return {
      title: 'üîÆ –í–∞—à –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ò–Ω—Å–∞–π—Ç',
      message: integration.personalizedReading,
      moonAdvice: integration.bestReadingTime,
      focusAreas: integration.focusAreas,
      opportunities: integration.opportunities,
      date: new Date().toISOString()
    };
  }
}

module.exports = new InsightsIntegrationService();
